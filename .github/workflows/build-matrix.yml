name: Build Matrix

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        subfolder: [elixir, go, node, python, rust]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image for ${{ matrix.subfolder }}
      run: |
        docker build -t ${{ matrix.subfolder }} -f ${{ matrix.subfolder }}/Dockerfile .
    
    - name: Start container on port 8080
      run: |
        docker run -d --name ${{ matrix.subfolder }}-container -p 8080:8080 ${{ matrix.subfolder }}
    
    - name: Wait for container to be ready
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8080/ > /dev/null 2>&1; do sleep 2; done' || true
    
    - name: Test endpoint with cURL
      run: |
        # Capture both response body and status code in one request
        response=$(curl -s -w "%{http_code}" http://localhost:8080/)
        
        # Parse response: last 3 characters are the status code, rest is body
        response_code="${response: -3}"
        response_body="${response%???}"
        
        # Get only the first line and strip newlines to prevent markdown table formatting issues
        response_body_clean=$(echo "$response_body" | head -n 1 | tr -d '\n\r')
        
        echo "HTTP response code: $response_code"
        echo "HTTP response body: $response_body_clean"
        
        # Create job summary
        echo "## 🚀 Container Test Results for ${{ matrix.subfolder }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **HTTP Status Code** | \`$response_code\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **HTTP Response Body** | \`$response_body_clean\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Endpoint** | \`http://localhost:8080/\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Container** | \`${{ matrix.subfolder }}-container\` |" >> $GITHUB_STEP_SUMMARY
        
        if [ "$response_code" -eq 200 ]; then
          echo "| **Test Result** | ✅ **PASSED** |" >> $GITHUB_STEP_SUMMARY
          echo "✅ Test passed: Received HTTP 200 from /"
        else
          echo "| **Test Result** | ❌ **FAILED** |" >> $GITHUB_STEP_SUMMARY
          echo "❌ Test failed: Expected HTTP 200, got $response_code"
          exit 1
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Cleanup container
      if: always()
      run: |
        docker stop ${{ matrix.subfolder }}-container || true
        docker rm ${{ matrix.subfolder }}-container || true
