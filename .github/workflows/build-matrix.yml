name: Build Matrix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  packages: write
  contents: read
  attestations: write
  id-token: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrixInclude: ${{ steps.gen.outputs.matrixInclude }}
    steps:
      - id: gen
        env:
          SERVICES: |
            hello-world-elixir:elixir/Dockerfile
            hello-world-go:go/Dockerfile
            hello-world-node:node/Dockerfile
            hello-world-python:python/Dockerfile
            hello-world-rust:rust/Dockerfile
        run: |
          # Convert the services to JSON array
          # jq pipeline explanation:
          # 1. -R -s: Read input as raw strings and treat as single string
          # 2. split("\n"): Split the multi-line string into array of lines
          # 3. map(select(length > 0)): Filter out empty lines
          # 4. map(gsub("^\\s+|\\s+$"; "")): Remove leading/trailing whitespace (strip equivalent)
          # 5. map(split(":")): Split each line on colon into [name, path] arrays
          # 6. map({...}): Transform each [name, path] into JSON object with containerName and dockerfilePath
          # 7. -c: Output compact JSON (single line, no formatting)
          JSON=$(echo "$SERVICES" | jq -R -s -c 'split("\n") | map(select(length > 0)) | map(gsub("^\\s+|\\s+$"; "")) | map(split(":")) | map({"containerName": .[0], "dockerfilePath": .[1]})')
          echo "matrixInclude=$JSON" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrixInclude) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      if: github.ref == 'refs/heads/main'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository_owner }}/${{ matrix.containerName }}
        tags: |
          type=raw,value=latest
          type=sha

    - name: Build Docker image for testing
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfilePath }}
        platforms: linux/amd64
        push: false
        load: true  # Load image into local Docker daemon for testing
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Start container on port 8080
      run: |
        # Use the first tag from metadata for local testing (since image is loaded with tags, not digest)
        LOCAL_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
        docker run -d --name ${{ matrix.containerName }}-container -p 8080:8080 "$LOCAL_TAG"

    - name: Wait for container to be ready
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8080/ > /dev/null 2>&1; do sleep 2; done' || true

    - name: Test endpoint with cURL
      run: |
        # Capture both response body and status code in one request
        response=$(curl -s -w "%{http_code}" http://localhost:8080/)

        # Parse response: last 3 characters are the status code, rest is body
        response_code="${response: -3}"
        response_body="${response%???}"

        # Get only the first line and strip newlines to prevent markdown table formatting issues
        response_body_clean=$(echo "$response_body" | head -n 1 | tr -d '\n\r')

        echo "HTTP response code: $response_code"
        echo "HTTP response body: $response_body_clean"

        # Store test results in artifacts for summary job
        mkdir -p test-results
        echo "${{ matrix.containerName }},${{ matrix.dockerfilePath }},$response_code,$response_body_clean" > test-results/${{ matrix.containerName }}.csv

        if [ "$response_code" -eq 200 ]; then
          echo "âœ… Test passed: Received HTTP 200 from /"
          echo "TEST_PASSED=true" >> $GITHUB_ENV
        else
          echo "âŒ Test failed: Expected HTTP 200, got $response_code"
          echo "TEST_PASSED=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Generate comprehensive SBOMs (Microsoft sbom-tool + BuildKit)
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ“‹ Generating comprehensive SBOMs with multiple tools..."
        
        # Install required tools
        echo "ðŸ”§ Installing tools..."
        
        # Download and install Microsoft's official sbom-tool
        curl -Lo sbom-tool https://github.com/microsoft/sbom-tool/releases/latest/download/sbom-tool-linux-x64
        chmod +x sbom-tool
        
        # Create output directories
        mkdir -p sbom-output sbom-buildkit
        
        # Extract the directory path from the dockerfile path for targeted scanning
        DOCKERFILE_DIR=$(dirname "${{ matrix.dockerfilePath }}")
        
        echo "ðŸ” Generating Microsoft SBOM for $DOCKERFILE_DIR..."
        
        # Generate SBOM in SPDX 2.2 format, scanning only the relevant directory
        ./sbom-tool generate \
          -b "$DOCKERFILE_DIR" \
          -bc "$DOCKERFILE_DIR" \
          -pn "${{ matrix.containerName }}" \
          -pv "sha-${{ github.sha }}" \
          -ps "${{ github.repository_owner }}" \
          -nsb "https://github.com/${{ github.repository_owner }}" \
          -mi SPDX:2.2 \
          -m sbom-output \
          -V Warning || {
            echo "âš ï¸  SBOM generation completed with warnings or no packages detected"
            echo "   This is normal for simple applications without external dependencies"
            # Ensure the SBOM file exists even if minimal
            if [ ! -f "sbom-output/_manifest/spdx_2.2/manifest.spdx.json" ]; then
              echo "ðŸ“ Creating minimal SBOM as fallback..."
              mkdir -p sbom-output/_manifest/spdx_2.2
              cat > sbom-output/_manifest/spdx_2.2/manifest.spdx.json << EOF
        {
          "spdxVersion": "SPDX-2.2",
          "dataLicense": "CC0-1.0",
          "SPDXID": "SPDXRef-DOCUMENT",
          "name": "${{ matrix.containerName }}",
          "documentNamespace": "https://github.com/${{ github.repository_owner }}/${{ matrix.containerName }}/sha-${{ github.sha }}",
          "creationInfo": {
            "created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "creators": ["Tool: Microsoft.Sbom.Tool", "Organization: ${{ github.repository_owner }}"]
          },
          "packages": [],
          "relationships": []
        }
        EOF
            fi
          }
        
        # Copy the generated SBOM to expected location for attestation
        cp sbom-output/_manifest/spdx_2.2/manifest.spdx.json sbom.spdx.json
        
        echo "âœ… Microsoft SBOM generated successfully"
        
        # Extract BuildKit SBOM from the built image and all layers
        echo "ðŸ³ Extracting BuildKit SBOM from container image and layers..."
        LOCAL_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
        
        # Try to extract BuildKit SBOM using buildx imagetools
        docker buildx imagetools inspect "$LOCAL_TAG" --format '{{ json .SBOM }}' > sbom-buildkit/buildkit-sbom.json 2>/dev/null || {
          echo "âš ï¸  BuildKit SBOM not found in image metadata, creating placeholder"
          echo '{"note": "No BuildKit SBOM available for this image", "reason": "BuildKit SBOM generation may not be enabled"}' > sbom-buildkit/buildkit-sbom.json
        }
        
        # Extract manifest to analyze layers
        echo "ðŸ” Analyzing container layers..."
        docker manifest inspect "$LOCAL_TAG" > sbom-buildkit/manifest.json 2>/dev/null || {
          echo "âš ï¸  Could not extract manifest"
          echo '{"note": "Manifest not available"}' > sbom-buildkit/manifest.json
        }
        
        # Try to extract layer information and potential SBOMs from each layer
        echo "ðŸ“Š Extracting layer-specific information..."
        docker inspect "$LOCAL_TAG" > sbom-buildkit/image-inspect.json 2>/dev/null || {
          echo '{"note": "Image inspection not available"}' > sbom-buildkit/image-inspect.json
        }
        
        # Try to get BuildKit provenance and SBOM attestations directly
        echo "ðŸ” Checking for BuildKit attestations..."
        docker buildx imagetools inspect "$LOCAL_TAG" --format '{{ json .Provenance }}' > sbom-buildkit/buildkit-provenance.json 2>/dev/null || {
          echo '{"note": "No BuildKit provenance available"}' > sbom-buildkit/buildkit-provenance.json
        }
        
        echo "âœ… SBOM generation and analysis completed"
        
        # Create a summary of findings for the summary step
        echo "ðŸ“ Creating SBOM summary..."
        echo "SBOM Analysis Summary for ${{ matrix.containerName }}" > sbom-summary.txt
        echo "" >> sbom-summary.txt
        echo "Microsoft SBOM Tool Results:" >> sbom-summary.txt
        if [ -s "sbom.spdx.json" ]; then
          echo "âœ… Microsoft SBOM generated successfully" >> sbom-summary.txt
          PACKAGE_COUNT=$(cat sbom.spdx.json | jq -r '.packages | length' 2>/dev/null || echo "unknown")
          echo "ðŸ“¦ Found $PACKAGE_COUNT packages" >> sbom-summary.txt
        else
          echo "âŒ Microsoft SBOM generation failed" >> sbom-summary.txt
        fi
        echo "" >> sbom-summary.txt
        echo "BuildKit SBOM Results:" >> sbom-summary.txt
        if grep -q '"note"' sbom-buildkit/buildkit-sbom.json 2>/dev/null; then
          echo "âš ï¸  BuildKit SBOM not available" >> sbom-summary.txt
        else
          echo "âœ… BuildKit SBOM extracted" >> sbom-summary.txt
        fi
        echo "" >> sbom-summary.txt
        echo "Container Layer Analysis:" >> sbom-summary.txt
        LAYER_COUNT=$(docker manifest inspect "$LOCAL_TAG" 2>/dev/null | jq -r '.layers | length' || echo "unknown")
        echo "ðŸ—‚ï¸  Container has $LAYER_COUNT layers" >> sbom-summary.txt
        
        echo "âœ… SBOM generation and analysis completed"

    - name: Build and push image with attestations
      id: build-push
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfilePath }}
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # Add attestations for supply chain security
        provenance: true
        sbom: true

    - name: Generate attestations
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ” Generating security attestations for ${{ matrix.containerName }}..."
        echo "   â†’ Build provenance attestation"
        echo "   â†’ SBOM attestation"
        echo "   (Individual attestation outputs suppressed - see combined summary)"

    - name: Generate GitHub artifact attestation
      id: build-attestation
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      uses: actions/attest-build-provenance@v2
      with:
        subject-name: ghcr.io/${{ github.repository_owner }}/${{ matrix.containerName }}
        subject-digest: ${{ steps.build-push.outputs.digest }}
        push-to-registry: true
        show-summary: false
      env:
        ACTIONS_STEP_DEBUG: false
        RUNNER_DEBUG: 0

    - name: Generate Microsoft SBOM attestation
      id: microsoft-sbom-attestation
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      uses: actions/attest-sbom@v2
      with:
        subject-name: ghcr.io/${{ github.repository_owner }}/${{ matrix.containerName }}
        subject-digest: ${{ steps.build-push.outputs.digest }}
        sbom-path: sbom.spdx.json
        push-to-registry: true
        show-summary: false
      env:
        ACTIONS_STEP_DEBUG: false
        RUNNER_DEBUG: 0

    - name: Generate BuildKit SBOM attestation
      id: buildkit-sbom-attestation
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      run: |
        # Check if BuildKit SBOM contains actual data (not just a placeholder)
        if [ -f "sbom-buildkit/buildkit-sbom.json" ] && ! grep -q '"note"' sbom-buildkit/buildkit-sbom.json 2>/dev/null; then
          echo "âœ… BuildKit SBOM contains real data, generating attestation..."
          echo "BUILDKIT_SBOM_AVAILABLE=true" >> $GITHUB_ENV
        else
          echo "âš ï¸  BuildKit SBOM is placeholder or empty, skipping attestation"
          echo "BUILDKIT_SBOM_AVAILABLE=false" >> $GITHUB_ENV
        fi

    - name: Attest BuildKit SBOM
      id: buildkit-sbom-attest
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main' && env.BUILDKIT_SBOM_AVAILABLE == 'true'
      uses: actions/attest-sbom@v2
      with:
        subject-name: ghcr.io/${{ github.repository_owner }}/${{ matrix.containerName }}
        subject-digest: ${{ steps.build-push.outputs.digest }}
        sbom-path: sbom-buildkit/buildkit-sbom.json
        push-to-registry: true
        show-summary: false
      env:
        ACTIONS_STEP_DEBUG: false
        RUNNER_DEBUG: 0

    - name: Store attestation results
      if: always() && env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ“ Storing attestation results for summary..."
        mkdir -p attestation-results
        
        # Check if attestations were successful and capture URLs
        build_status="âŒ Failed"
        microsoft_sbom_status="âŒ Failed"
        buildkit_sbom_status="âŒ Not Available"
        build_url=""
        microsoft_sbom_url=""
        buildkit_sbom_url=""
        
        if [[ "${{ steps.build-attestation.outcome }}" == "success" ]]; then
          build_status="âœ… Signed"
          build_url="${{ steps.build-attestation.outputs.attestation-url }}"
        fi
        
        if [[ "${{ steps.microsoft-sbom-attestation.outcome }}" == "success" ]]; then
          microsoft_sbom_status="âœ… Signed"
          microsoft_sbom_url="${{ steps.microsoft-sbom-attestation.outputs.attestation-url }}"
        fi
        
        if [[ "${{ steps.buildkit-sbom-attest.outcome }}" == "success" ]]; then
          buildkit_sbom_status="âœ… Signed"
          buildkit_sbom_url="${{ steps.buildkit-sbom-attest.outputs.attestation-url }}"
        elif [[ "$BUILDKIT_SBOM_AVAILABLE" == "false" ]]; then
          buildkit_sbom_status="âš ï¸  No Data"
        fi
        
        echo "${{ matrix.containerName }},${{ matrix.dockerfilePath }},${{ steps.build-push.outputs.digest }},$build_status,$microsoft_sbom_status,$buildkit_sbom_status,$build_url,$microsoft_sbom_url,$buildkit_sbom_url" > attestation-results/${{ matrix.containerName }}.csv
        echo "âœ… Attestation results stored for ${{ matrix.containerName }}"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.containerName }}
        path: test-results/
        retention-days: 1

    - name: Upload attestation results
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: attestation-results-${{ matrix.containerName }}
        path: attestation-results/
        retention-days: 1

    - name: Upload SBOM artifacts
      if: env.TEST_PASSED == 'true' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: sbom-files-${{ matrix.containerName }}
        path: |
          sbom-buildkit/
          sbom-summary.txt
          sbom.spdx.json
        retention-days: 30

    - name: Cleanup container
      if: always()
      run: |
        docker stop ${{ matrix.containerName }}-container || true
        docker rm ${{ matrix.containerName }}-container || true

  summary:
    runs-on: ubuntu-latest
    needs: build
    if: always()

    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        path: all-results
        merge-multiple: true

    - name: Download all attestation results
      uses: actions/download-artifact@v4
      with:
        pattern: attestation-results-*
        path: all-attestations
        merge-multiple: true

    - name: Download all SBOM artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: sbom-files-*
        path: all-sboms
        merge-multiple: true

    - name: Create combined summary
      run: |
        echo "# ðŸš€ Container Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Container Name | Dockerfile Path | Status Code | Response Body | Test Result |" >> $GITHUB_STEP_SUMMARY
        echo "|----------------|-----------------|-------------|---------------|-------------|" >> $GITHUB_STEP_SUMMARY

        for file in all-results/*.csv; do
          if [ -f "$file" ]; then
            IFS=',' read -r container dockerfile_path status_code response_body < "$file"
            if [ "$status_code" -eq 200 ]; then
              result="âœ… PASSED"
            else
              result="âŒ FAILED"
            fi
            echo "| **$container** | \`$dockerfile_path\` | \`$status_code\` | \`$response_body\` | $result |" >> $GITHUB_STEP_SUMMARY
          fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY

        # Add registry push information for main builds
        if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
          echo "## ðŸ“¦ Published Container Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following images were pushed to GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for file in all-results/*.csv; do
            if [ -f "$file" ]; then
              IFS=',' read -r container dockerfile_path status_code response_body < "$file"
              if [ "$status_code" -eq 200 ]; then
                echo "- ðŸ“¦ \`ghcr.io/${{ github.repository_owner }}/$container:latest\`" >> $GITHUB_STEP_SUMMARY
                echo "- ðŸ“¦ \`ghcr.io/${{ github.repository_owner }}/$container:sha-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ **Pull images:** \`docker pull ghcr.io/${{ github.repository_owner }}/IMAGE_NAME:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add comprehensive attestations summary
          echo "## ðŸ” Security Attestations Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "all-attestations" ] && [ "$(ls -A all-attestations 2>/dev/null)" ]; then
            echo "| Container | Dockerfile | Image Digest | Build Provenance | Microsoft SBOM | BuildKit SBOM | Verification |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------------|-------------|------------------|----------------|---------------|--------------|" >> $GITHUB_STEP_SUMMARY
            
            for file in all-attestations/*.csv; do
              if [ -f "$file" ]; then
                IFS=',' read -r container dockerfile_path digest build_status microsoft_sbom_status buildkit_sbom_status build_url microsoft_sbom_url buildkit_sbom_url < "$file"
                short_digest="${digest#sha256:}"
                short_digest="${short_digest:0:12}"
                
                # Create hyperlinked status for build provenance
                if [[ "$build_status" == "âœ… Signed" && -n "$build_url" ]]; then
                  build_display="[âœ… Signed]($build_url)"
                else
                  build_display="$build_status"
                fi
                
                # Create hyperlinked status for Microsoft SBOM
                if [[ "$microsoft_sbom_status" == "âœ… Signed" && -n "$microsoft_sbom_url" ]]; then
                  microsoft_sbom_display="[âœ… Signed]($microsoft_sbom_url)"
                else
                  microsoft_sbom_display="$microsoft_sbom_status"
                fi
                
                # Create hyperlinked status for BuildKit SBOM
                if [[ "$buildkit_sbom_status" == "âœ… Signed" && -n "$buildkit_sbom_url" ]]; then
                  buildkit_sbom_display="[âœ… Signed]($buildkit_sbom_url)"
                else
                  buildkit_sbom_display="$buildkit_sbom_status"
                fi
                
                echo "| **$container** | \`$dockerfile_path\` | \`$short_digest...\` | $build_display | $microsoft_sbom_display | $buildkit_sbom_display | \`gh attestation verify oci://ghcr.io/${{ github.repository_owner }}/$container:latest\` |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ›¡ï¸ Attestation Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All published images include comprehensive supply chain security attestations:" >> $GITHUB_STEP_SUMMARY
            echo "- **Build Provenance**: GitHub artifact attestations establishing build source and environment" >> $GITHUB_STEP_SUMMARY
            echo "- **Microsoft SBOM**: Software Bill of Materials attestations in SPDX format from Microsoft sbom-tool" >> $GITHUB_STEP_SUMMARY
            echo "- **BuildKit SBOM**: Software Bill of Materials from Docker BuildKit (when available)" >> $GITHUB_STEP_SUMMARY
            echo "- **Docker Attestations**: Native Docker BuildKit provenance and SBOM" >> $GITHUB_STEP_SUMMARY
            echo "- **SLSA Compliance**: Meets SLSA v1.0 Build Level 2 requirements" >> $GITHUB_STEP_SUMMARY
          else
            echo "No attestations were generated (likely due to test failures or non-main branch)." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add comprehensive SBOM analysis
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Software Bill of Materials (SBOM) Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "all-sboms" ] && [ "$(ls -A all-sboms 2>/dev/null)" ]; then
            echo "Comprehensive SBOM analysis using multiple tools and formats:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Create a summary table of SBOM counts by container
            echo "| Container | Microsoft SBOM | BuildKit SBOM | Container Layers | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------------|---------------|------------------|--------|" >> $GITHUB_STEP_SUMMARY
            
            # Process each container's SBOM data
            for result_file in all-results/*.csv; do
              if [ -f "$result_file" ]; then
                IFS=',' read -r container dockerfile_path status_code response_body < "$result_file"
                if [ "$status_code" -eq 200 ]; then
                  
                  # Count Microsoft SBOM packages
                  microsoft_count="0"
                  microsoft_json_file="all-sboms/sbom.spdx.json"
                  if [ -f "$microsoft_json_file" ]; then
                    microsoft_count=$(cat "$microsoft_json_file" | jq -r '.packages | length' 2>/dev/null || echo "0")
                  fi
                  
                  # Check BuildKit SBOM status
                  buildkit_status="Not Available"
                  buildkit_json_file="all-sboms/sbom-buildkit/buildkit-sbom.json"
                  if [ -f "$buildkit_json_file" ]; then
                    if grep -q '"note"' "$buildkit_json_file" 2>/dev/null; then
                      buildkit_status="Placeholder"
                    else
                      # Try to count BuildKit SBOM components (structure may vary)
                      buildkit_count=$(cat "$buildkit_json_file" | jq -r 'if .packages then .packages | length elif .predicate.buildInfo.sbom.packages then .predicate.buildInfo.sbom.packages | length else "0" end' 2>/dev/null || echo "Available")
                      if [[ "$buildkit_count" =~ ^[0-9]+$ ]]; then
                        buildkit_status="$buildkit_count packages"
                      else
                        buildkit_status="Available"
                      fi
                    fi
                  fi
                  
                  # Count container layers
                  layer_count="unknown"
                  manifest_file="all-sboms/sbom-buildkit/manifest.json"
                  if [ -f "$manifest_file" ]; then
                    layer_count=$(cat "$manifest_file" | jq -r '.layers | length' 2>/dev/null || echo "unknown")
                  fi
                  
                  # Determine overall status
                  overall_status="âœ… Complete"
                  if [ "$microsoft_count" = "0" ] && [ "$buildkit_status" = "Not Available" ]; then
                    overall_status="âš ï¸  Minimal"
                  elif [ "$buildkit_status" = "Not Available" ]; then
                    overall_status="ðŸ“‹ Microsoft Only"
                  fi
                  
                  echo "| **$container** | $microsoft_count packages | $buildkit_status | $layer_count layers | $overall_status |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Process each container's detailed SBOM summary from the build step
            for summary_file in all-sboms/sbom-summary.txt; do
              if [ -f "$summary_file" ]; then
                echo "### ï¿½ Detailed SBOM Analysis" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                cat "$summary_file" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
          else
            echo "No SBOM data available (likely due to test failures or non-main branch)." >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        # Container package visibility information for main branch builds
        if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
          echo "## ðŸ“¦ Published Container Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following images were pushed to GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for file in all-results/*.csv; do
            if [ -f "$file" ]; then
              IFS=',' read -r container dockerfile_path status_code response_body < "$file"
              if [ "$status_code" -eq 200 ]; then
                echo "- ðŸ“¦ \`ghcr.io/${{ github.repository_owner }}/$container:latest\`" >> $GITHUB_STEP_SUMMARY
                echo "- ðŸ“¦ \`ghcr.io/${{ github.repository_owner }}/$container:sha-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ **Pull images:** \`docker pull ghcr.io/${{ github.repository_owner }}/IMAGE_NAME:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
